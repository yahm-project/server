<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v1.6.0/leaflet.css" />
    <script src="http://cdn.leafletjs.com/leaflet/v1.6.0/leaflet.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol/dist/L.Control.Locate.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol/dist/L.Control.Locate.min.js" charset="utf-8"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css">
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-geosearch@2.7.0/dist/style.css">
    <script src="https://unpkg.com/leaflet-geosearch@2.7.0/dist/bundle.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-geosearch@2.6.0/assets/css/leaflet.css">
    <style>
        body {
            padding: 0;
            margin: 0;
        }
        html, body, #map {
            height: 100%;
            width: 100%;
        }
    </style>
</head>
<body>
<div id="map"></div>

<script>
var MIN_ZOOM_TO_SHOW_DATA = 14

var potHoleIcon = L.icon({
    iconUrl: '/images/pot-hole-marker.png',

    iconSize:     [70, 70], // size of the icon
    iconAnchor:   [35, 70], // point of the icon which will correspond to marker's location
    popupAnchor:  [35, 0] // point from which the popup should open relative to the iconAnchor
});

var mymap = L.map('map', {
    center: [44.133331, 12.233333],
    zoom: 18,
    maxNativeZoom: 18,
    maxZoom: 18,
    minZoom: 6,
    zoomControl: false
});

var MAPBOX_TOKEN = 'pk.eyJ1IjoiZ2lhY29tb3RvbnRpbmkiLCJhIjoiY2s5Y3h0d2hxMDNjYjNtcGxmYTA3dnYzMSJ9.EoujETnFYtRxAox-ne97mQ'
L.tileLayer('https://api.mapbox.com/styles/v1/mapbox/streets-v11/tiles/256/{z}/{x}/{y}?access_token=' + MAPBOX_TOKEN, {
        attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
}).addTo(mymap);

L.control.zoom({
    position: 'bottomright'
}).addTo(mymap);

var lc = L.control.locate({
    position: 'bottomright',
    enableHighAccuracy: true,
    flyTo: true,
    locateOptions: {
        maxZoom: 18
    },
    strings: {
        title: "Show me where I am, yo!"
    }}).addTo(mymap);
lc.start()


const provider = new window.GeoSearch.OpenStreetMapProvider();
const searchControl = new window.GeoSearch.GeoSearchControl({
  provider: provider,
  style: 'bar',
  showMarker: false,
  autoClose: true,
  retainZoomLevel: true,
  searchLabel: 'Looking for new places?'
});
mymap.addControl(searchControl);


var roadDefectsMarkerCluster = L.markerClusterGroup();
mymap.addLayer(roadDefectsMarkerCluster);


function addMarker(coordinates, type) {
    var icon = potHoleIcon
    /*if(type == "POTHOLE") {}
    else if (type == "ROAD-JOINT") {}
    else if (type == "3") {}
    else if (type == "4") {}*/
    roadDefectsMarkerCluster.addLayer(L.marker(coordinates, {icon: icon}));
}


var qualityToColor = { 1: "green", 2: "yellow", 3: "red" };
function drawRoadSegment(roadSegments) {
    var segments = JSON.parse(roadSegments);
    for(const segment of segments) {
        console.log(segment)
        console.log(segment.from.lat, segment.from.lng, segment.to.lat, segment.to.lng, qualityToColor[segment.quality])
        var polyline = L.polyline([[segment.from.lat, segment.from.lng], [segment.to.lat, segment.to.lng]], {color: qualityToColor[segment.quality], weight: 5}).addTo(mymap);
    }
}

var lastCenter = mymap.getCenter()
mymap.on('movestart', function(ev) {
    lastCenter = mymap.getCenter()
});

mymap.on('move', function(ev) {
    if(!mymap.getBounds().contains(lastCenter) && mymap.getZoom() > MIN_ZOOM_TO_SHOW_DATA) {
        lastCenter = mymap.getCenter()
        console.log("time to ask for new data", lastCenter)
    }
});


mymap.on('zoomend', function(ev) {
    if(mymap.getZoom() > MIN_ZOOM_TO_SHOW_DATA) {
        console.log("zoom has changed, asking for new data with more radius", ev)
    }
});


</script>
</body>
</html>